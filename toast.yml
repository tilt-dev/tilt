image: gcr.io/windmill-public-containers/tilt-toast@sha256:9330037b32d9d746153082ce8d892cadb4367913f2fe8a460a5aa899ff832b44
command_prefix: set -euo pipefail
location: /go/src/github.com/tilt-dev/tilt
tasks:
  webview-proto:
    input_paths:
      - pkg/webview/log.proto
      - pkg/webview/view.proto
      - pkg/apis/core/v1alpha1/generated.proto
      - vendor/k8s.io/apimachinery/pkg/runtime/generated.proto
      - vendor/k8s.io/apimachinery/pkg/runtime/schema/generated.proto
      - vendor/k8s.io/apimachinery/pkg/apis/meta/v1/generated.proto
    output_paths:
      - pkg/webview/log.pb.go
      - pkg/webview/view.pb.go
      - pkg/webview/view_grpc.pb.go
      - pkg/webview/view.swagger.json
    command: |
      mkdir -p web/src
      protoc \
       -I. \
       -I./vendor \
       -I/usr/include \
       -I"$(go list -f "{{.Dir}}" -m "github.com/grpc-ecosystem/grpc-gateway@latest")/third_party/googleapis" \
       --grpc-gateway_out=logtostderr=true:. \
       --swagger_out=logtostderr=true:. \
       --go_out=. --go_opt=paths=source_relative \
       --go-grpc_out=. --go-grpc_opt=paths=source_relative \
       pkg/webview/*.proto
      sed -i 's|v1alpha1 "pkg/apis/core/v1alpha1"|v1alpha1 "github.com/tilt-dev/tilt/pkg/apis/core/v1alpha1"|g' pkg/webview/*.pb.go 
      sed -i 's|"$ref": "#/definitions/v1Time",|"type": "string", "format": "date-time",|g' pkg/webview/view.swagger.json
      sed -i 's|"$ref": "#/definitions/v1MicroTime",|"type": "string", "format": "date-time",|g' pkg/webview/view.swagger.json
      goimports -local github.com/tilt-dev -w pkg/webview/*.pb.go

  proto-ts:
    dependencies:
      - webview-proto
    input_paths:
      - pkg/webview/view.swagger.json
    output_paths:
      - web/src/view.d.ts
    command: |
      swagger-to-ts pkg/webview/view.swagger.json --camelcase --wrapper "
      // Autogenerated: DO NOT EDIT
      declare namespace Proto
      " --output web/src/view.d.ts
      sed -i 's|v1alpha1 "pkg/apis/core/v1alpha1"|v1alpha1 "github.com/tilt-dev/tilt/pkg/apis/core/v1alpha1"|g' pkg/webview/*.pb.go

  wire:
    input_paths:
      - go.mod
      - go.sum
      - cmd
      - integration
      - internal
      - pkg
      - web/web.go
      - vendor
      - Makefile
    output_paths:
      - ./internal/cli/wire_gen.go
      - ./internal/engine/wire_gen.go
      - ./internal/engine/buildcontrol/wire_gen.go
    command: |
      make wire-dev
      make goimports
